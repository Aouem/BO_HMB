<!-- checklist-detail.component.html -->
<div class="checklist-detail-container">
  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Chargement de la checklist...</p>
  </div>

  <!-- Erreur -->
  <div *ngIf="!loading && errorMsg" class="error-container">
    <div class="alert alert-danger">
      {{ errorMsg }}
    </div>
  </div>

  <!-- Contenu principal -->
  <ng-container *ngIf="!loading && !errorMsg && agg">
    <!-- En-tête -->
    <header class="detail-header">
      <h1 class="checklist-title">
         {{ agg.libelle }} »
      </h1>
      <div class="checklist-stats">
        <span class="stat-badge">{{ totalSubmissions }} soumission(s)</span>
        <span class="stat-badge">{{ agg.etapes.length }} étape(s)</span>
      </div>
    </header>

    <!-- Tableau des soumissions -->
    <section class="submissions-section">
      <h2 class="section-title">📊 Historique des Soumissions</h2>

      <div *ngIf="!hasRealSubmissions" class="no-submissions">
        <div class="empty-state">
          <h3>Aucune soumission trouvée</h3>
          <p>Les soumissions apparaîtront ici une fois que le formulaire sera complété.</p>
        </div>
      </div>

      <div *ngIf="hasRealSubmissions" class="table-container">
        <table class="submissions-table">
          <thead>
            <tr>
              <th class="col-id">ID Soumission</th>
              <th class="col-date">Date</th>
              <th class="col-user">Utilisateur</th>
              <th class="col-status">Statut</th>
              <th class="col-actions">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let submission of submissions; trackBy: trackBySubmission" 
                class="submission-row">
              
              <!-- ID Soumission -->
              <td class="col-id">
                <span class="submission-id">#{{ submission.id }}</span>
              </td>

              <!-- Date -->
              <td class="col-date">
                <span class="submission-date">{{ formatDate(submission.submittedAt) }}</span>
              </td>

              <!-- Utilisateur -->
              <td class="col-user">
                <span class="submission-user">{{ submission.submittedBy }}</span>
              </td>

              <!-- Statut -->
              <td class="col-status">
                <span class="status-badge" [ngClass]="getSubmissionStatus(submission).class">
                  {{ getSubmissionStatus(submission).text }}
                </span>
              </td>

              <!-- Actions -->
              <td class="col-actions">
                <button 
                  class="btn-detail"
                  (click)="showSubmissionDetails(submission)">
                  📋 Détails
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Modal de détails -->
    <div *ngIf="selectedSubmission" class="modal-overlay" (click)="hideSubmissionDetails()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        
        <!-- En-tête du modal -->
        <div class="modal-header">
          <h3>📋 Détails de la Soumission #{{ selectedSubmission.id }}</h3>
          <button class="btn-close" (click)="hideSubmissionDetails()">×</button>
        </div>
        
        <!-- Informations de la soumission -->
        <div class="modal-body">
          <div class="submission-info">
            <div class="info-grid">
              <div class="info-item">
                <label>Checklist:</label>
                <span>{{ agg.libelle }}</span>
              </div>
              <div class="info-item">
                <label>Date:</label>
                <span>{{ formatDate(selectedSubmission.submittedAt) }}</span>
              </div>
              <div class="info-item">
                <label>Utilisateur:</label>
                <span>{{ selectedSubmission.submittedBy }}</span>
              </div>
              <div class="info-item">
                <label>Nombre de réponses:</label>
                <span>{{ selectedSubmission.reponses.length }}</span>
              </div>
            </div>
          </div>

          <!-- Résumé statistique -->
          <div class="responses-summary">
            <h4>📈 Résumé des réponses</h4>
            <div class="stats-grid">
              <div class="stat-item">
                <span class="stat-value">{{ countResponsesByType(selectedSubmission).oui }}</span>
                <span class="stat-label">✅ Oui</span>
              </div>
              <div class="stat-item">
                <span class="stat-value">{{ countResponsesByType(selectedSubmission).non }}</span>
                <span class="stat-label">❌ Non</span>
              </div>
              <div class="stat-item">
                <span class="stat-value">{{ countResponsesByType(selectedSubmission).na }}</span>
                <span class="stat-label">⚪ N/A</span>
              </div>
              <div class="stat-item">
                <span class="stat-value">{{ countResponsesByType(selectedSubmission).texte }}</span>
                <span class="stat-label">📝 Texte</span>
              </div>
            </div>
          </div>

          <!-- Détails des questions/réponses -->
          <div class="questions-details">
            <h4>📋 Détail des vérifications</h4>
            
            <!-- Grouper par étape -->
            <div *ngFor="let etape of getGroupedResponses(selectedSubmission)" class="etape-group">
              <h5 class="etape-name">{{ etape.name }}</h5>
              
              <div *ngFor="let response of etape.responses; let i = index; trackBy: trackByResponse" 
                   class="response-item">
                <div class="response-question">
                  <strong>Q{{ i + 1 }}:</strong> 
                  {{ response.questionText }}
                </div>
                <div class="response-answer" [ngClass]="getAnswerClass(response.reponse)">
                  <strong>Réponse:</strong> {{ response.reponse }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Pied du modal -->
        <div class="modal-footer">
          <button class="btn-close-modal" (click)="hideSubmissionDetails()">
            Fermer
          </button>
        </div>
      </div>
    </div>
  </ng-container>
</div>