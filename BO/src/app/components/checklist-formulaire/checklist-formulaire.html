<div class="formulaire-container">
  <!-- Écran de sélection des checklists -->
  <div *ngIf="showChecklistSelection" class="checklist-selection">
    <div class="selection-header">
      <h1>📋 Sélectionnez une Checklist</h1>
      <p>Choisissez la checklist que vous souhaitez compléter</p>
    </div>

    <!-- Loading -->
    <div *ngIf="loading" class="loading-container">
      <div class="spinner"></div>
      <p>Chargement des checklists...</p>
    </div>

    <!-- Grille des checklists -->
    <div *ngIf="!loading" class="checklists-grid">
      <div *ngFor="let checklist of allChecklists" 
           class="checklist-card"
           (click)="selectChecklist(checklist)">
        
        <div class="card-header">
          <h3 class="card-title">{{ checklist.libelle }}</h3>
          <div class="card-badge">
            {{ checklist.etapes.length || 0 }} étapes
          </div>
        </div>

        <div class="card-content">
          <p class="card-description" *ngIf="checklist.description">
            {{ checklist.description }}
          </p>
          <p class="card-questions">
            📝 {{ getTotalQuestions(checklist) }} questions
          </p>
        </div>

        <div class="card-footer">
          <button class="btn-select">
            Sélectionner →
          </button>
        </div>
      </div>
    </div>

    <!-- État vide -->
    <div *ngIf="!loading && allChecklists.length === 0" class="empty-state">
      <h2>Aucune checklist disponible</h2>
      <p>Créez d'abord des checklists dans la section administration.</p>
    </div>
  </div>

  <!-- Formulaire de la checklist sélectionnée -->
  <div *ngIf="!showChecklistSelection && selectedChecklist" class="checklist-form">
    
    <!-- En-tête du formulaire -->
    <div class="form-header">
      <button class="btn-back" (click)="backToSelection()">
        ← Retour aux checklists
      </button>
      <h1>{{ checklistNom }}</h1>
      <div class="form-stats">
        <span class="stat">{{ answeredQuestions }}/{{ totalQuestions }} réponses</span>
        <span class="stat">{{ etapesCompletees }}/{{ etapes.length }} étapes</span>
      </div>
    </div>

    <!-- Barre de progression -->
    <div class="progress-section">
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="getGlobalProgress()"></div>
      </div>
      <span class="progress-text">{{ getGlobalProgress() | number:'1.0-0' }}% complété</span>
    </div>

    <!-- Mode vue d'ensemble des étapes -->
    <div *ngIf="mode === 'etape'" class="etapes-overview">
      <!-- Boucle des étapes normales (sans la décision finale) -->
      <div *ngFor="let etape of etapes; let i = index" 
           class="etape-card" 
           [class.complete]="etapesValidees[i]"
           [class.current]="i === currentEtapeIndex"
           [class.locked]="!isEtapeAccessible(i)">
        
        <div class="etape-header">
          <div class="etape-indicator">
            <span class="etape-number">{{ i + 1 }}</span>
            <div class="etape-status" [class.validated]="etapesValidees[i]">
              {{ etapesValidees[i] ? '✓' : (isEtapeAccessible(i) ? '○' : '🔒') }}
            </div>
          </div>
          
          <div class="etape-info">
            <h3 class="etape-title">{{ etape.nom }}</h3>
            <p class="etape-stats">
              {{ getEtapeAnsweredQuestions(i) }}/{{ etape.questions.length }} réponses
            </p>
          </div>

          <div class="etape-progress">
            <div class="progress-bar small">
              <div class="progress-fill" [style.width.%]="getEtapeProgress(i)"></div>
            </div>
          </div>
        </div>

        <div class="etape-actions">
          <button *ngIf="!etapesValidees[i]" 
                  class="btn-start"
                  [class.disabled]="!isEtapeAccessible(i)"
                  [title]="getEtapeTooltip(i)"
                  (click)="commencerEtape(i)"
                  [disabled]="!isEtapeAccessible(i)">
            {{ i === currentEtapeIndex ? 'Continuer' : 'Commencer' }}
          </button>
          
          <button *ngIf="etapesValidees[i]" 
                  class="btn-review"
                  (click)="commencerEtape(i)">
            Réviser
          </button>

          <button *ngIf="etapesValidees[i]" 
                  class="btn-reopen"
                  (click)="reouvrirEtape(i)">
            Rouvrir
          </button>
        </div>

        <!-- Message d'étape verrouillée -->
        <div *ngIf="!isEtapeAccessible(i) && !etapesValidees[i]" class="locked-message">
          <span class="lock-icon">🔒</span>
          <span class="locked-text">Validez les étapes précédentes pour déverrouiller</span>
        </div>
      </div>

      <!-- DÉCISION FINALE - Section séparée (APRÈS les étapes normales) -->
      <div *ngIf="toutesEtapesValidees()" class="decision-finale-section">
        <div class="decision-card">
          <h3 class="decision-title">🎯 DÉCISION FINALE</h3>
          
          <div class="decision-question">
            <p class="decision-text">GO = OK pour incision</p>
            
            <!-- Boutons Oui/Non comme les autres questions -->
            <div class="answer-options decision-buttons">
              <button 
                class="answer-btn"
                [ngClass]="getDecisionBtnClasses('Oui')"
                (click)="onDecisionSelected('Oui')">
                Oui
              </button>
              
              <button 
                class="answer-btn"
                [ngClass]="getDecisionBtnClasses('Non')"
                (click)="onDecisionSelected('Non')">
                Non
              </button>
            </div>
          </div>

          <!-- Conséquences (affichage conditionnel seulement pour Non) -->
          <div *ngIf="decisionFinale === 'Non'" class="consequences-section">
            <h4 class="consequences-title">Si NO GO : conséquence sur l'intervention ?</h4>
            
            <div class="consequences-options">
              <button 
                class="consequence-btn"
                [ngClass]="getConsequenceBtnClasses('Retard')"
                (click)="onConsequenceSelected('Retard')">
                <span class="consequence-icon">⏰</span>
                Retard
              </button>
              
              <button 
                class="consequence-btn"
                [ngClass]="getConsequenceBtnClasses('Annulation')"
                (click)="onConsequenceSelected('Annulation')">
                <span class="consequence-icon">🚫</span>
                Annulation
              </button>
            </div>
          </div>

          <!-- Message de statut -->
          <div *ngIf="decisionFinale" class="decision-status">
            <p [class]="getDecisionStatusClass()">
              {{ getDecisionStatusText() }}
            </p>
          </div>
        </div>
      </div>

      <!-- Message si la décision finale n'est pas encore accessible -->
      <div *ngIf="!toutesEtapesValidees()" class="decision-locked-section">
        <div class="decision-card locked">
          <h3 class="decision-title">🎯 DÉCISION FINALE</h3>
          <div class="locked-decision-message">
            <span class="lock-icon">🔒</span>
            <p>Validez toutes les étapes précédentes pour accéder à la décision finale</p>
            <div class="etapes-restantes">
              Étapes restantes : {{ etapes.length - etapesCompletees }}/{{ etapes.length }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Mode question par question -->
    <div *ngIf="mode === 'question' && currentEtape" class="question-mode">
      <div class="question-header">
        <h2>{{ currentEtape.nom }}</h2>
        <div class="question-nav">
          <span class="question-counter">
            Question {{ currentQuestionIndex + 1 }}/{{ currentEtape.questions.length }}
          </span>
          <button class="btn-back-to-overview" (click)="retourAuTableauDeBord()">
            ← Vue d'ensemble
          </button>
        </div>
      </div>

      <div *ngIf="currentQuestion" class="question-container">
        <div class="question-card">
          <h3 class="question-text">{{ currentQuestion.texte }}</h3>
          
          <div *ngIf="currentQuestion.type === 'Boolean' || currentQuestion.type === 'BooleanNA'" 
               class="answer-options">
            <button *ngFor="let option of getBooleanOptions(currentQuestion.type)"
                    class="answer-btn"
                    [ngClass]="getChoiceBtnClasses(currentQuestion.id, option)"
                    (click)="onAnswerSelected(currentQuestion.id, option)">
              {{ option }}
            </button>
          </div>

          <div *ngIf="currentQuestion.type === 'Texte'" class="text-answer">
            <textarea 
              class="form-control"
              [value]="getQuestionResponse(currentQuestion.id) || ''"
              (input)="onAnswerSelected(currentQuestion.id, $any($event.target).value)"
              placeholder="Saisissez votre réponse..."
              rows="4">
            </textarea>
          </div>
        </div>

        <div class="question-navigation">
          <button class="btn-prev" 
                  (click)="prevQuestion()"
                  [disabled]="isFirstQuestion">
            ← Précédent
          </button>

          <button *ngIf="!isLastQuestionInEtape"
                  class="btn-next"
                  (click)="nextQuestion()"
                  [disabled]="!canGoNext()">
            Suivant →
          </button>

          <button *ngIf="isLastQuestionInEtape"
                  class="btn-validate"
                  (click)="validerEtape()"
                  [disabled]="!isEtapeComplete(currentEtapeIndex)">
            Valider l'étape ✓
          </button>
        </div>
      </div>
    </div>

    <!-- Actions globales -->
    <div class="global-actions" *ngIf="mode === 'etape'">
      <button class="btn-reset" (click)="resetForm()">
        🔄 Recommencer
      </button>
      
      <button class="btn-preview" (click)="previewSoumission()">
        👁️ Prévisualiser
      </button>
      
      <button class="btn-history" (click)="viewSubmissionHistory()">
        📊 Historique
      </button>

      <!-- BOUTON D'IMPRESSION -->
      <button *ngIf="toutesEtapesValidees() && isDecisionComplete()" 
              class="btn-print"
              (click)="printChecklist()">
        🖨️ Imprimer la Checklist
      </button>

      <button *ngIf="toutesEtapesValidees() && isDecisionComplete()" 
              class="btn-submit"
              (click)="submitFinalForm()">
        ✅ Soumettre le formulaire
      </button>

      <button *ngIf="toutesEtapesValidees() && !isDecisionComplete()" 
              class="btn-submit-disabled"
              disabled>
        ⚠️ Complétez la décision finale
      </button>
    </div>

    <!-- Message de soumission réussie -->
    <div *ngIf="submitted" class="submission-success">
      <h3>✅ Formulaire soumis avec succès !</h3>
      <p>Vos réponses ont été enregistrées dans le système.</p>
      
      <div *ngIf="decisionFinale" class="submission-decision">
        <strong>Décision finale :</strong> 
        <span [class.text-success]="decisionFinale === 'Oui'" 
              [class.text-danger]="decisionFinale === 'Non'">
          {{ decisionFinale === 'Oui' ? 'GO' : 'NO GO' }}
        </span>
        
        <div *ngIf="decisionFinale === 'Non' && consequence" class="submission-consequence">
          <strong>Conséquence :</strong> {{ consequence }}
        </div>
      </div>
      
      <button class="btn-new" (click)="resetForm()">
        📝 Nouveau formulaire
      </button>
      
      <!-- BOUTON D'IMPRESSION APRÈS SOUMISSION -->
      <button class="btn-print" (click)="printChecklist()">
        🖨️ Imprimer la Checklist
      </button>
    </div>
  </div>

  <!-- MODAL D'IMPRESSION POUR LA CHECKLIST BLOC OPÉRATOIRE -->
  <div *ngIf="showPrintModal" class="print-modal-overlay">
    <div class="print-modal">
      <div class="print-modal-header">
        <h2>🖨️ Impression de la Checklist Bloc Opératoire</h2>
        <button class="btn-close" (click)="closePrintModal()">×</button>
      </div>
      
      <div class="print-modal-content">
        <div id="checklist-print-content" class="checklist-print-version">
          
          <!-- REPRODUCTION EXACTE DE LA CHECKLIST PDF -->
          <div class="print-header">
            <h1>CHECK-LIST « SÉCURITÉ DU PATIENT AU BLOC OPÉRATOIRE »</h1>
            <h2>Version 2018</h2>
            <p class="print-motto">« Vérifier ensemble pour décider »</p>
            <div class="patient-info-print">
              <p><strong>Patient :</strong> {{ patientNom }} | 
                 <strong>Date :</strong> {{ currentDate | date:'dd/MM/yyyy HH:mm' }} | 
                 <strong>Intervention :</strong> {{ interventionType }}</p>
            </div>
          </div>

          <hr>

          <!-- SECTION AVANT INDUCTION ANESTHÉSIQUE -->
          <div class="print-section">
            <h2>AVANT INDUCTION ANESTHÉSIQUE</h2>
            <p class="print-subtitle"><strong>Temps de pause avant anesthésie</strong></p>
            
            <div class="print-item">
              <p><strong>L'identité du patient est correcte</strong></p>
              <div class="checkbox-print">
                <span [class.checked]="isQuestionCheckedForPrint('identite_patient', 'Oui')">☐ Oui</span>
                <span [class.checked]="isQuestionCheckedForPrint('identite_patient', 'Non')">☐ Non</span>
              </div>
            </div>

            <div class="print-item">
              <p><strong>L'autorisation d'opérer est signée par les parents ou le représentant légal</strong></p>
              <div class="checkbox-print">
                <span [class.checked]="isQuestionCheckedForPrint('autorisation_operer', 'Oui')">☐ Oui</span>
                <span [class.checked]="isQuestionCheckedForPrint('autorisation_operer', 'Non')">☐ Non</span>
              </div>
            </div>

            <div class="print-item">
              <p><strong>L'intervention et le site opératoire sont confirmés :</strong></p>
              <p class="indented">- idéalement par le patient et, dans tous les cas, par le dossier ou procédure spécifique</p>
              <p class="indented">- la documentation clinique et sans clinique nécessaire est disponible en salle</p>
              <div class="checkbox-print">
                <span [class.checked]="isQuestionCheckedForPrint('intervention_site', 'Oui')">☐ Oui</span>
                <span [class.checked]="isQuestionCheckedForPrint('intervention_site', 'Non')">☐ Non</span>
              </div>
            </div>

            <div class="print-item">
              <p><strong>Le mode d'installation est connu de l'équipe en salle, cohérent avec le site / l'intervention et non dangereux pour le patient</strong></p>
              <div class="checkbox-print">
                <span [class.checked]="isQuestionCheckedForPrint('mode_installation', 'Oui')">☐ Oui</span>
                <span [class.checked]="isQuestionCheckedForPrint('mode_installation', 'Non')">☐ Non</span>
              </div>
            </div>

            <div class="print-item">
              <p><strong>La préparation cutanée de l'opéré est documentée dans la fiche de liaison service / bloc opératoire (ou autre procédure en œuvre dans l'établissement)</strong></p>
              <div class="checkbox-print">
                <span [class.checked]="isQuestionCheckedForPrint('preparation_cutanee', 'Oui')">☐ Oui</span>
                <span [class.checked]="isQuestionCheckedForPrint('preparation_cutanee', 'Non')">☐ Non</span>
              </div>
            </div>

            <div class="print-item">
              <p><strong>L'équipement / le matériel nécessaires pour l'intervention sont vérifiés et adaptés au poids et à la taille du patient</strong></p>
              <p class="indented">- pour la partie chirurgicale</p>
              <p class="indented">- pour la partie anesthésique</p>
              <p class="indented">- Actes aux piles en charge anesthésique</p>
              <div class="checkbox-print">
                <span [class.checked]="isQuestionCheckedForPrint('equipement_materiel', 'Oui')">☐ Oui</span>
                <span [class.checked]="isQuestionCheckedForPrint('equipement_materiel', 'Non')">☐ Non</span>
              </div>
            </div>

            <div class="print-item">
              <p><strong>Le patient présente-t-il un :</strong></p>
              <p class="indented">- risque allergique</p>
              <p class="indented">- risque d'inhalation, de difficulté d'intubation ou de ventilation au masque</p>
              <p class="indented">- risque de saignement important</p>
            </div>
          </div>

          <hr>

          <!-- SECTION AVANT INTERVENTION CHIRURGICALE -->
          <div class="print-section">
            <h2>AVANT INTERVENTION CHIRURGICALE</h2>
            <p class="print-subtitle"><strong>Temps de pause avant incision (appelé aussi time-out)</strong></p>
            
            <div class="print-item">
              <p><strong>Vérification « ultime » cuisée au sein de l'équipe en présence des chirurgiens(s), anesthésiste(s), IADE-BODEF/IDE</strong></p>
              <p class="indented">- identité patient confirmée</p>
              <p class="indented">- intervention prévue confirmée</p>
              <p class="indented">- site opératoire confirmée</p>
              <p class="indented">- installation correcte confirmée</p>
              <p class="indented">- documents nécessaires disponibles (notamment imaginé)</p>
              <div class="checkbox-print">
                <span [class.checked]="isQuestionCheckedForPrint('verification_ultime', 'Oui')">☐ Oui</span>
                <span [class.checked]="isQuestionCheckedForPrint('verification_ultime', 'Non')">☐ Non</span>
              </div>
            </div>

            <div class="print-item">
              <p><strong>Partage des informations essentielles oralement au sein de l'équipe sur les éléments à risque / étapes critiques de l'intervention (time-out)</strong></p>
              <p class="indented">- sur le plan chirurgical</p>
              <p class="indented-small">(temps opératoire difficile, points spécifiques de l'intervention, identifications des matériels nécessaires, confirmation de leur opérationnalité, etc.)</p>
              <p class="indented">- sur le plan anesthésique</p>
              <p class="indented-small">Actes aux piles en charge anesthésique (tommes potentiels liés au niveau (hypothermie, etc.) ou à des traitements réinvestiment maintenus, etc.)</p>
              <div class="checkbox-print">
                <span [class.checked]="isQuestionCheckedForPrint('partage_informations', 'Oui')">☐ Oui</span>
                <span [class.checked]="isQuestionCheckedForPrint('partage_informations', 'Non')">☐ Non</span>
              </div>
            </div>

            <div class="print-item">
              <p><strong>L'antholymphatose a été effectuée selon les recommandations et pronostics en vigueur dans l'établissement</strong></p>
              <p><strong>La préparation du champ opératoire est réalisée selon le protocole en vigueur dans l'établissement</strong></p>
            </div>
          </div>

          <hr>

          <!-- SECTION APRÈS INTERVENTION -->
          <div class="print-section">
            <h2>APRÈS INTERVENTION</h2>
            <p class="print-subtitle"><strong>Pause avant sortie de salle d'opération</strong></p>
            
            <div class="print-item">
              <p><strong>Confirmation orale par le personnel auprès de l'équipe :</strong></p>
              <p class="indented">- de l'intervention enregistrée</p>
              <p class="indented">- du compte final correct</p>
              <p class="indented">- des compresses, aiguilles, instruments, etc.</p>
              <p class="indented">- de l'étiquetage des prélèvements, pièces opératoires, etc.</p>
              <p class="indented">- à des événements indésirables ou porteurs de risques médicaux sont suivants :</p>
              <p class="indented">- oni-lis fait l'objet d'un signalement / déclaration ?</p>
              <p class="indented">- Si aucun événement indésirable n'est survenu pendant l'intervention couler M/A</p>
              <div class="checkbox-print">
                <span [class.checked]="isQuestionCheckedForPrint('confirmation_orale', 'Oui')">☐ Oui</span>
                <span [class.checked]="isQuestionCheckedForPrint('confirmation_orale', 'Non')">☐ Non</span>
              </div>
            </div>

            <div class="print-item">
              <p><strong>Les prescriptions et la surveillance post-opératoires (y compris les seuils d'alerte spécifiques) sont faites complètement par l'équipe chirurgicale et anesthésique et adaptées à l'âge, au poids et à la taille du patient</strong></p>
              <div class="checkbox-print">
                <span [class.checked]="isQuestionCheckedForPrint('prescriptions_surveillance', 'Oui')">☐ Oui</span>
                <span [class.checked]="isQuestionCheckedForPrint('prescriptions_surveillance', 'Non')">☐ Non</span>
              </div>
            </div>
          </div>

          <hr>

          <!-- SECTION DÉCISION FINALE -->
          <div class="print-section decision-section">
            <h2>DÉCISION FINALE</h2>
            
            <div class="decision-finale-print">
              <div class="decision-option">
                <span [class.checked]="decisionFinale === 'Oui'">☐ GO = OK pour incision</span>
              </div>
              <div class="decision-option">
                <span [class.checked]="decisionFinale === 'Non'">☐ NO GO = Pas d'incision !</span>
              </div>
            </div>

            <div *ngIf="decisionFinale === 'Non'" class="consequences-print">
              <p><strong>Si No Go : conséquence sur l'intervention ?</strong></p>
              <div class="checkbox-print">
                <span [class.checked]="consequence === 'Retard'">☐ Retard</span>
                <span [class.checked]="consequence === 'Annulation'">☐ Annulation</span>
              </div>
            </div>
          </div>

          <!-- SIGNATURES -->
          <div class="signatures-section">
            <p class="signature-title"><strong>SELON PROCÉDURE EN VIGUEUR DANS L'ÉTABLISSEMENT</strong></p>
            <p class="signature-subtitle">Attestation que la check-list a été renseignée suite à un partage des informations entre les membres de l'équipe</p>
            
            <div class="signatures-grid">
              <div class="signature-box">
                <div class="signature-line"></div>
                <p>Chirurgien</p>
              </div>
              <div class="signature-box">
                <div class="signature-line"></div>
                <p>Anesthésiste / IADE</p>
              </div>
              <div class="signature-box">
                <div class="signature-line"></div>
                <p>Coordonnateur CL</p>
              </div>
            </div>
          </div>

        </div>

        <div class="print-actions">
          <button class="btn-print-now" (click)="printChecklistNow()">
            🖨️ Imprimer maintenant
          </button>
          <button class="btn-print-cancel" (click)="closePrintModal()">
            Annuler
          </button>
        </div>
      </div>
    </div>
  </div>
</div>