<!-- checklist-formulaire.html -->
<div class="formulaire-container">
  <!-- Écran de sélection des checklists -->
  <div *ngIf="showChecklistSelection" class="checklist-selection">
    <div class="selection-header">
      <h1>📋 Sélectionnez une Checklist</h1>
      <p>Choisissez la checklist que vous souhaitez compléter</p>
    </div>

    <!-- Loading -->
    <div *ngIf="loading" class="loading-container">
      <div class="spinner"></div>
      <p>Chargement des checklists...</p>
    </div>

    <!-- Grille des checklists -->
    <div *ngIf="!loading" class="checklists-grid">
      <div *ngFor="let checklist of allChecklists" 
           class="checklist-card"
           (click)="selectChecklist(checklist)">
        
        <div class="card-header">
          <h3 class="card-title">{{ checklist.libelle }}</h3>
          <div class="card-badge">
            {{ checklist.etapes.length || 0 }} étapes
          </div>
        </div>

        <div class="card-content">
          <p class="card-description" *ngIf="checklist.description">
            {{ checklist.description }}
          </p>
          <p class="card-questions">
            📝 {{ getTotalQuestions(checklist) }} questions
          </p>
        </div>

        <div class="card-footer">
          <button class="btn-select">
            Sélectionner →
          </button>
        </div>
      </div>
    </div>

    <!-- État vide -->
    <div *ngIf="!loading && allChecklists.length === 0" class="empty-state">
      <h2>Aucune checklist disponible</h2>
      <p>Créez d'abord des checklists dans la section administration.</p>
    </div>
  </div>

  <!-- Formulaire de la checklist sélectionnée -->
  <div *ngIf="!showChecklistSelection && selectedChecklist" class="checklist-form">
    
    <!-- En-tête du formulaire -->
    <div class="form-header">
      <button class="btn-back" (click)="backToSelection()">
        ← Retour aux checklists
      </button>
      <h1>{{ checklistNom }}</h1>
      <div class="form-stats">
        <span class="stat">{{ answeredQuestions }}/{{ totalQuestions }} réponses</span>
        <span class="stat">{{ etapesCompletees }}/{{ etapes.length }} étapes</span>
      </div>
    </div>

    <!-- Barre de progression -->
    <div class="progress-section">
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="getGlobalProgress()"></div>
      </div>
      <span class="progress-text">{{ getGlobalProgress() | number:'1.0-0' }}% complété</span>
    </div>

    <!-- Mode vue d'ensemble des étapes -->
    <div *ngIf="mode === 'etape'" class="etapes-overview">
      <div *ngFor="let etape of etapes; let i = index" 
           class="etape-card" 
           [class.complete]="etapesValidees[i]"
           [class.current]="i === currentEtapeIndex">
        
        <div class="etape-header">
          <div class="etape-indicator">
            <span class="etape-number">{{ i + 1 }}</span>
            <div class="etape-status" [class.validated]="etapesValidees[i]">
              {{ etapesValidees[i] ? '✓' : '○' }}
            </div>
          </div>
          
          <div class="etape-info">
            <h3 class="etape-title">{{ etape.nom }}</h3>
            <p class="etape-stats">
              {{ getEtapeAnsweredQuestions(i) }}/{{ etape.questions.length }} réponses
            </p>
          </div>

          <div class="etape-progress">
            <div class="progress-bar small">
              <div class="progress-fill" [style.width.%]="getEtapeProgress(i)"></div>
            </div>
          </div>
        </div>

        <div class="etape-actions">
          <button *ngIf="!etapesValidees[i]" 
                  class="btn-start"
                  (click)="commencerEtape(i)">
            {{ i === currentEtapeIndex ? 'Continuer' : 'Commencer' }}
          </button>
          
          <button *ngIf="etapesValidees[i]" 
                  class="btn-review"
                  (click)="commencerEtape(i)">
            Réviser
          </button>

          <button *ngIf="etapesValidees[i]" 
                  class="btn-reopen"
                  (click)="reouvrirEtape(i)">
            Rouvrir
          </button>
        </div>
      </div>
    </div>

    <!-- Mode question par question -->
    <div *ngIf="mode === 'question' && currentEtape" class="question-mode">
      <div class="question-header">
        <h2>{{ currentEtape.nom }}</h2>
        <div class="question-nav">
          <span class="question-counter">
            Question {{ currentQuestionIndex + 1 }}/{{ currentEtape.questions.length }}
          </span>
          <button class="btn-back-to-overview" (click)="retourAuTableauDeBord()">
            ← Vue d'ensemble
          </button>
        </div>
      </div>

      <div *ngIf="currentQuestion" class="question-container">
        <div class="question-card">
          <h3 class="question-text">{{ currentQuestion.texte }}</h3>
          
          <div *ngIf="currentQuestion.type === 'Boolean' || currentQuestion.type === 'BooleanNA'" 
               class="answer-options">
            <button *ngFor="let option of getBooleanOptions(currentQuestion.type)"
                    class="answer-btn"
                    [ngClass]="getChoiceBtnClasses(currentQuestion.id, option)"
                    (click)="onAnswerSelected(currentQuestion.id, option)">
              {{ option }}
            </button>
          </div>

          <div *ngIf="currentQuestion.type === 'Texte'" class="text-answer">
            <textarea 
              class="form-control"
              [value]="getQuestionResponse(currentQuestion.id) || ''"
              (input)="onAnswerSelected(currentQuestion.id, $any($event.target).value)"
              placeholder="Saisissez votre réponse..."
              rows="4">
            </textarea>
          </div>

          <!-- Ajouter d'autres types de questions si nécessaire -->
        </div>

        <div class="question-navigation">
          <button class="btn-prev" 
                  (click)="prevQuestion()"
                  [disabled]="isFirstQuestion">
            ← Précédent
          </button>

          <button *ngIf="!isLastQuestionInEtape"
                  class="btn-next"
                  (click)="nextQuestion()"
                  [disabled]="!canGoNext()">
            Suivant →
          </button>

          <button *ngIf="isLastQuestionInEtape"
                  class="btn-validate"
                  (click)="validerEtape()"
                  [disabled]="!isEtapeComplete(currentEtapeIndex)">
            Valider l'étape ✓
          </button>
        </div>
      </div>
    </div>

    <!-- Actions globales -->
    <div class="global-actions" *ngIf="mode === 'etape'">
      <button class="btn-reset" (click)="resetForm()">
        🔄 Recommencer
      </button>
      
      <button class="btn-preview" (click)="previewSoumission()">
        👁️ Prévisualiser
      </button>
      
      <button class="btn-history" (click)="viewSubmissionHistory()">
        📊 Historique
      </button>

      <button *ngIf="toutesEtapesValidees()" 
              class="btn-submit"
              (click)="submitFinalForm()">
        ✅ Soumettre le formulaire
      </button>
    </div>

    <!-- Message de soumission réussie -->
    <div *ngIf="submitted" class="submission-success">
      <h3>✅ Formulaire soumis avec succès !</h3>
      <p>Vos réponses ont été enregistrées dans le système.</p>
      <button class="btn-new" (click)="resetForm()">
        📝 Nouveau formulaire
      </button>
    </div>
  </div>
</div>