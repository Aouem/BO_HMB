<div class="formulaire-container">
  <!-- √âcran de s√©lection des checklists -->
  <div *ngIf="showChecklistSelection" class="checklist-selection">
    <div class="selection-header">
      <h1>üìã S√©lectionnez une Checklist</h1>
      <p>Choisissez la checklist que vous souhaitez compl√©ter</p>
    </div>

    <!-- Loading -->
    <div *ngIf="loading" class="loading-container">
      <div class="spinner"></div>
      <p>Chargement des checklists...</p>
    </div>

    <!-- Grille des checklists -->
    <div *ngIf="!loading" class="checklists-grid">
      <div *ngFor="let checklist of allChecklists" 
           class="checklist-card"
           (click)="selectChecklist(checklist)">
        
        <div class="card-header">
          <h3 class="card-title">{{ checklist.libelle }}</h3>
          <div class="card-badge">
            {{ checklist.etapes.length || 0 }} √©tapes
          </div>
        </div>

        <div class="card-content">
          <p class="card-description" *ngIf="checklist.description">
            {{ checklist.description }}
          </p>
          <p class="card-questions">
            üìù {{ getTotalQuestions(checklist) }} questions
          </p>
        </div>

        <div class="card-footer">
          <button class="btn-select">
            S√©lectionner ‚Üí
          </button>
        </div>
      </div>
    </div>

    <!-- √âtat vide -->
    <div *ngIf="!loading && allChecklists.length === 0" class="empty-state">
      <h2>Aucune checklist disponible</h2>
      <p>Cr√©ez d'abord des checklists dans la section administration.</p>
    </div>
  </div>

  <!-- Formulaire de la checklist s√©lectionn√©e -->
  <div *ngIf="!showChecklistSelection && selectedChecklist" class="checklist-form">
    
    <!-- En-t√™te du formulaire -->
    <div class="form-header">
      <button class="btn-back" (click)="backToSelection()">
        ‚Üê Retour aux checklists
      </button>
      <h1>{{ checklistNom }}</h1>
      <div class="form-stats">
        <span class="stat">{{ answeredQuestions }}/{{ totalQuestions }} r√©ponses</span>
        <span class="stat">{{ etapesCompletees }}/{{ etapes.length }} √©tapes</span>
      </div>
    </div>

    <!-- Barre de progression -->
    <div class="progress-section">
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="getGlobalProgress()"></div>
      </div>
      <span class="progress-text">{{ getGlobalProgress() | number:'1.0-0' }}% compl√©t√©</span>
    </div>

    <!-- Mode vue d'ensemble des √©tapes -->
    <div *ngIf="mode === 'etape'" class="etapes-overview">
      <!-- Boucle des √©tapes normales (sans la d√©cision finale) -->
      <div *ngFor="let etape of etapes; let i = index" 
           class="etape-card" 
           [class.complete]="etapesValidees[i]"
           [class.current]="i === currentEtapeIndex"
           [class.locked]="!isEtapeAccessible(i)">
        
        <div class="etape-header">
          <div class="etape-indicator">
            <span class="etape-number">{{ i + 1 }}</span>
            <div class="etape-status" [class.validated]="etapesValidees[i]">
              {{ etapesValidees[i] ? '‚úì' : (isEtapeAccessible(i) ? '‚óã' : 'üîí') }}
            </div>
          </div>
          
          <div class="etape-info">
            <h3 class="etape-title">{{ etape.nom }}</h3>
            <p class="etape-stats">
              {{ getEtapeAnsweredQuestions(i) }}/{{ etape.questions.length }} r√©ponses
            </p>
          </div>

          <div class="etape-progress">
            <div class="progress-bar small">
              <div class="progress-fill" [style.width.%]="getEtapeProgress(i)"></div>
            </div>
          </div>
        </div>

        <div class="etape-actions">
          <button *ngIf="!etapesValidees[i]" 
                  class="btn-start"
                  [class.disabled]="!isEtapeAccessible(i)"
                  [title]="getEtapeTooltip(i)"
                  (click)="commencerEtape(i)"
                  [disabled]="!isEtapeAccessible(i)">
            {{ i === currentEtapeIndex ? 'Continuer' : 'Commencer' }}
          </button>
          
          <button *ngIf="etapesValidees[i]" 
                  class="btn-review"
                  (click)="commencerEtape(i)">
            R√©viser
          </button>

          <button *ngIf="etapesValidees[i]" 
                  class="btn-reopen"
                  (click)="reouvrirEtape(i)">
            Rouvrir
          </button>
        </div>

        <!-- Message d'√©tape verrouill√©e -->
        <div *ngIf="!isEtapeAccessible(i) && !etapesValidees[i]" class="locked-message">
          <span class="lock-icon">üîí</span>
          <span class="locked-text">Validez les √©tapes pr√©c√©dentes pour d√©verrouiller</span>
        </div>
      </div>

      <!-- D√âCISION FINALE - Section s√©par√©e (APR√àS les √©tapes normales) -->
      <div *ngIf="toutesEtapesValidees()" class="decision-finale-section">
        <div class="decision-card">
          <h3 class="decision-title">üéØ D√âCISION FINALE</h3>
          
          <div class="decision-question">
            <p class="decision-text">GO = OK pour incision</p>
            
            <!-- Boutons Oui/Non comme les autres questions -->
            <div class="answer-options decision-buttons">
              <button 
                class="answer-btn"
                [ngClass]="getDecisionBtnClasses('Oui')"
                (click)="onDecisionSelected('Oui')">
                Oui
              </button>
              
              <button 
                class="answer-btn"
                [ngClass]="getDecisionBtnClasses('Non')"
                (click)="onDecisionSelected('Non')">
                Non
              </button>
            </div>
          </div>

          <!-- Cons√©quences (affichage conditionnel seulement pour Non) -->
          <div *ngIf="decisionFinale === 'Non'" class="consequences-section">
            <h4 class="consequences-title">Si NO GO : cons√©quence sur l'intervention ?</h4>
            
            <div class="consequences-options">
              <button 
                class="consequence-btn"
                [ngClass]="getConsequenceBtnClasses('Retard')"
                (click)="onConsequenceSelected('Retard')">
                <span class="consequence-icon">‚è∞</span>
                Retard
              </button>
              
              <button 
                class="consequence-btn"
                [ngClass]="getConsequenceBtnClasses('Annulation')"
                (click)="onConsequenceSelected('Annulation')">
                <span class="consequence-icon">üö´</span>
                Annulation
              </button>
            </div>
          </div>

          <!-- Message de statut -->
          <div *ngIf="decisionFinale" class="decision-status">
            <p [class]="getDecisionStatusClass()">
              {{ getDecisionStatusText() }}
            </p>
          </div>
        </div>
      </div>

      <!-- Message si la d√©cision finale n'est pas encore accessible -->
      <div *ngIf="!toutesEtapesValidees()" class="decision-locked-section">
        <div class="decision-card locked">
          <h3 class="decision-title">üéØ D√âCISION FINALE</h3>
          <div class="locked-decision-message">
            <span class="lock-icon">üîí</span>
            <p>Validez toutes les √©tapes pr√©c√©dentes pour acc√©der √† la d√©cision finale</p>
            <div class="etapes-restantes">
              √âtapes restantes : {{ etapes.length - etapesCompletees }}/{{ etapes.length }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Mode question par question -->
    <div *ngIf="mode === 'question' && currentEtape" class="question-mode">
      <div class="question-header">
        <h2>{{ currentEtape.nom }}</h2>
        <div class="question-nav">
          <span class="question-counter">
            Question {{ currentQuestionIndex + 1 }}/{{ currentEtape.questions.length }}
          </span>
          <button class="btn-back-to-overview" (click)="retourAuTableauDeBord()">
            ‚Üê Vue d'ensemble
          </button>
        </div>
      </div>

      <div *ngIf="currentQuestion" class="question-container">
        <div class="question-card">
          <h3 class="question-text">{{ currentQuestion.texte }}</h3>
          
          <div *ngIf="currentQuestion.type === 'Boolean' || currentQuestion.type === 'BooleanNA'" 
               class="answer-options">
            <button *ngFor="let option of getBooleanOptions(currentQuestion.type)"
                    class="answer-btn"
                    [ngClass]="getChoiceBtnClasses(currentQuestion.id, option)"
                    (click)="onAnswerSelected(currentQuestion.id, option)">
              {{ option }}
            </button>
          </div>

          <div *ngIf="currentQuestion.type === 'Texte'" class="text-answer">
            <textarea 
              class="form-control"
              [value]="getQuestionResponse(currentQuestion.id) || ''"
              (input)="onAnswerSelected(currentQuestion.id, $any($event.target).value)"
              placeholder="Saisissez votre r√©ponse..."
              rows="4">
            </textarea>
          </div>
        </div>

        <div class="question-navigation">
          <button class="btn-prev" 
                  (click)="prevQuestion()"
                  [disabled]="isFirstQuestion">
            ‚Üê Pr√©c√©dent
          </button>

          <button *ngIf="!isLastQuestionInEtape"
                  class="btn-next"
                  (click)="nextQuestion()"
                  [disabled]="!canGoNext()">
            Suivant ‚Üí
          </button>

          <button *ngIf="isLastQuestionInEtape"
                  class="btn-validate"
                  (click)="validerEtape()"
                  [disabled]="!isEtapeComplete(currentEtapeIndex)">
            Valider l'√©tape ‚úì
          </button>
        </div>
      </div>
    </div>

    <!-- Actions globales -->
    <div class="global-actions" *ngIf="mode === 'etape'">
      <button class="btn-reset" (click)="resetForm()">
        üîÑ Recommencer
      </button>
      
      <button class="btn-preview" (click)="previewSoumission()">
        üëÅÔ∏è Pr√©visualiser
      </button>
      
      <button class="btn-history" (click)="viewSubmissionHistory()">
        üìä Historique
      </button>

      <!-- BOUTON D'IMPRESSION -->
      <button *ngIf="toutesEtapesValidees() && isDecisionComplete()" 
              class="btn-print"
              (click)="printChecklist()">
        üñ®Ô∏è Imprimer la Checklist
      </button>

      <button *ngIf="toutesEtapesValidees() && isDecisionComplete()" 
              class="btn-submit"
              (click)="submitFinalForm()">
        ‚úÖ Soumettre le formulaire
      </button>

      <button *ngIf="toutesEtapesValidees() && !isDecisionComplete()" 
              class="btn-submit-disabled"
              disabled>
        ‚ö†Ô∏è Compl√©tez la d√©cision finale
      </button>
    </div>

    <!-- Message de soumission r√©ussie -->
    <div *ngIf="submitted" class="submission-success">
      <h3>‚úÖ Formulaire soumis avec succ√®s !</h3>
      <p>Vos r√©ponses ont √©t√© enregistr√©es dans le syst√®me.</p>
      
      <div *ngIf="decisionFinale" class="submission-decision">
        <strong>D√©cision finale :</strong> 
        <span [class.text-success]="decisionFinale === 'Oui'" 
              [class.text-danger]="decisionFinale === 'Non'">
          {{ decisionFinale === 'Oui' ? 'GO' : 'NO GO' }}
        </span>
        
        <div *ngIf="decisionFinale === 'Non' && consequence" class="submission-consequence">
          <strong>Cons√©quence :</strong> {{ consequence }}
        </div>
      </div>
      
      <button class="btn-new" (click)="resetForm()">
        üìù Nouveau formulaire
      </button>
      
      <!-- BOUTON D'IMPRESSION APR√àS SOUMISSION -->
      <button class="btn-print" (click)="printChecklist()">
        üñ®Ô∏è Imprimer la Checklist
      </button>
    </div>
  </div>

  <!-- MODAL D'IMPRESSION POUR LA CHECKLIST BLOC OP√âRATOIRE -->
  <div *ngIf="showPrintModal" class="print-modal-overlay">
    <div class="print-modal">
      <div class="print-modal-header">
        <h2>üñ®Ô∏è Impression de la Checklist Bloc Op√©ratoire</h2>
        <button class="btn-close" (click)="closePrintModal()">√ó</button>
      </div>
      
      <div class="print-modal-content">
        <div id="checklist-print-content" class="checklist-print-version">
          
          <!-- REPRODUCTION EXACTE DE LA CHECKLIST PDF -->
          <div class="print-header">
            <h1>CHECK-LIST ¬´ S√âCURIT√â DU PATIENT AU BLOC OP√âRATOIRE ¬ª</h1>
            <h2>Version 2018</h2>
            <p class="print-motto">¬´ V√©rifier ensemble pour d√©cider ¬ª</p>
            <div class="patient-info-print">
              <p><strong>Patient :</strong> {{ patientNom }} | 
                 <strong>Date :</strong> {{ currentDate | date:'dd/MM/yyyy HH:mm' }} | 
                 <strong>Intervention :</strong> {{ interventionType }}</p>
            </div>
          </div>

          <hr>

          <!-- SECTION AVANT INDUCTION ANESTH√âSIQUE -->
          <div class="print-section">
            <h2>AVANT INDUCTION ANESTH√âSIQUE</h2>
            <p class="print-subtitle"><strong>Temps de pause avant anesth√©sie</strong></p>
            
            <div class="print-item">
              <p><strong>L'identit√© du patient est correcte</strong></p>
              <div class="checkbox-print">
                <span [class.checked]="isQuestionCheckedForPrint('identite_patient', 'Oui')">‚òê Oui</span>
                <span [class.checked]="isQuestionCheckedForPrint('identite_patient', 'Non')">‚òê Non</span>
              </div>
            </div>

            <div class="print-item">
              <p><strong>L'autorisation d'op√©rer est sign√©e par les parents ou le repr√©sentant l√©gal</strong></p>
              <div class="checkbox-print">
                <span [class.checked]="isQuestionCheckedForPrint('autorisation_operer', 'Oui')">‚òê Oui</span>
                <span [class.checked]="isQuestionCheckedForPrint('autorisation_operer', 'Non')">‚òê Non</span>
              </div>
            </div>

            <div class="print-item">
              <p><strong>L'intervention et le site op√©ratoire sont confirm√©s :</strong></p>
              <p class="indented">- id√©alement par le patient et, dans tous les cas, par le dossier ou proc√©dure sp√©cifique</p>
              <p class="indented">- la documentation clinique et sans clinique n√©cessaire est disponible en salle</p>
              <div class="checkbox-print">
                <span [class.checked]="isQuestionCheckedForPrint('intervention_site', 'Oui')">‚òê Oui</span>
                <span [class.checked]="isQuestionCheckedForPrint('intervention_site', 'Non')">‚òê Non</span>
              </div>
            </div>

            <div class="print-item">
              <p><strong>Le mode d'installation est connu de l'√©quipe en salle, coh√©rent avec le site / l'intervention et non dangereux pour le patient</strong></p>
              <div class="checkbox-print">
                <span [class.checked]="isQuestionCheckedForPrint('mode_installation', 'Oui')">‚òê Oui</span>
                <span [class.checked]="isQuestionCheckedForPrint('mode_installation', 'Non')">‚òê Non</span>
              </div>
            </div>

            <div class="print-item">
              <p><strong>La pr√©paration cutan√©e de l'op√©r√© est document√©e dans la fiche de liaison service / bloc op√©ratoire (ou autre proc√©dure en ≈ìuvre dans l'√©tablissement)</strong></p>
              <div class="checkbox-print">
                <span [class.checked]="isQuestionCheckedForPrint('preparation_cutanee', 'Oui')">‚òê Oui</span>
                <span [class.checked]="isQuestionCheckedForPrint('preparation_cutanee', 'Non')">‚òê Non</span>
              </div>
            </div>

            <div class="print-item">
              <p><strong>L'√©quipement / le mat√©riel n√©cessaires pour l'intervention sont v√©rifi√©s et adapt√©s au poids et √† la taille du patient</strong></p>
              <p class="indented">- pour la partie chirurgicale</p>
              <p class="indented">- pour la partie anesth√©sique</p>
              <p class="indented">- Actes aux piles en charge anesth√©sique</p>
              <div class="checkbox-print">
                <span [class.checked]="isQuestionCheckedForPrint('equipement_materiel', 'Oui')">‚òê Oui</span>
                <span [class.checked]="isQuestionCheckedForPrint('equipement_materiel', 'Non')">‚òê Non</span>
              </div>
            </div>

            <div class="print-item">
              <p><strong>Le patient pr√©sente-t-il un :</strong></p>
              <p class="indented">- risque allergique</p>
              <p class="indented">- risque d'inhalation, de difficult√© d'intubation ou de ventilation au masque</p>
              <p class="indented">- risque de saignement important</p>
            </div>
          </div>

          <hr>

          <!-- SECTION AVANT INTERVENTION CHIRURGICALE -->
          <div class="print-section">
            <h2>AVANT INTERVENTION CHIRURGICALE</h2>
            <p class="print-subtitle"><strong>Temps de pause avant incision (appel√© aussi time-out)</strong></p>
            
            <div class="print-item">
              <p><strong>V√©rification ¬´ ultime ¬ª cuis√©e au sein de l'√©quipe en pr√©sence des chirurgiens(s), anesth√©siste(s), IADE-BODEF/IDE</strong></p>
              <p class="indented">- identit√© patient confirm√©e</p>
              <p class="indented">- intervention pr√©vue confirm√©e</p>
              <p class="indented">- site op√©ratoire confirm√©e</p>
              <p class="indented">- installation correcte confirm√©e</p>
              <p class="indented">- documents n√©cessaires disponibles (notamment imagin√©)</p>
              <div class="checkbox-print">
                <span [class.checked]="isQuestionCheckedForPrint('verification_ultime', 'Oui')">‚òê Oui</span>
                <span [class.checked]="isQuestionCheckedForPrint('verification_ultime', 'Non')">‚òê Non</span>
              </div>
            </div>

            <div class="print-item">
              <p><strong>Partage des informations essentielles oralement au sein de l'√©quipe sur les √©l√©ments √† risque / √©tapes critiques de l'intervention (time-out)</strong></p>
              <p class="indented">- sur le plan chirurgical</p>
              <p class="indented-small">(temps op√©ratoire difficile, points sp√©cifiques de l'intervention, identifications des mat√©riels n√©cessaires, confirmation de leur op√©rationnalit√©, etc.)</p>
              <p class="indented">- sur le plan anesth√©sique</p>
              <p class="indented-small">Actes aux piles en charge anesth√©sique (tommes potentiels li√©s au niveau (hypothermie, etc.) ou √† des traitements r√©investiment maintenus, etc.)</p>
              <div class="checkbox-print">
                <span [class.checked]="isQuestionCheckedForPrint('partage_informations', 'Oui')">‚òê Oui</span>
                <span [class.checked]="isQuestionCheckedForPrint('partage_informations', 'Non')">‚òê Non</span>
              </div>
            </div>

            <div class="print-item">
              <p><strong>L'antholymphatose a √©t√© effectu√©e selon les recommandations et pronostics en vigueur dans l'√©tablissement</strong></p>
              <p><strong>La pr√©paration du champ op√©ratoire est r√©alis√©e selon le protocole en vigueur dans l'√©tablissement</strong></p>
            </div>
          </div>

          <hr>

          <!-- SECTION APR√àS INTERVENTION -->
          <div class="print-section">
            <h2>APR√àS INTERVENTION</h2>
            <p class="print-subtitle"><strong>Pause avant sortie de salle d'op√©ration</strong></p>
            
            <div class="print-item">
              <p><strong>Confirmation orale par le personnel aupr√®s de l'√©quipe :</strong></p>
              <p class="indented">- de l'intervention enregistr√©e</p>
              <p class="indented">- du compte final correct</p>
              <p class="indented">- des compresses, aiguilles, instruments, etc.</p>
              <p class="indented">- de l'√©tiquetage des pr√©l√®vements, pi√®ces op√©ratoires, etc.</p>
              <p class="indented">- √† des √©v√©nements ind√©sirables ou porteurs de risques m√©dicaux sont suivants :</p>
              <p class="indented">- oni-lis fait l'objet d'un signalement / d√©claration ?</p>
              <p class="indented">- Si aucun √©v√©nement ind√©sirable n'est survenu pendant l'intervention couler M/A</p>
              <div class="checkbox-print">
                <span [class.checked]="isQuestionCheckedForPrint('confirmation_orale', 'Oui')">‚òê Oui</span>
                <span [class.checked]="isQuestionCheckedForPrint('confirmation_orale', 'Non')">‚òê Non</span>
              </div>
            </div>

            <div class="print-item">
              <p><strong>Les prescriptions et la surveillance post-op√©ratoires (y compris les seuils d'alerte sp√©cifiques) sont faites compl√®tement par l'√©quipe chirurgicale et anesth√©sique et adapt√©es √† l'√¢ge, au poids et √† la taille du patient</strong></p>
              <div class="checkbox-print">
                <span [class.checked]="isQuestionCheckedForPrint('prescriptions_surveillance', 'Oui')">‚òê Oui</span>
                <span [class.checked]="isQuestionCheckedForPrint('prescriptions_surveillance', 'Non')">‚òê Non</span>
              </div>
            </div>
          </div>

          <hr>

          <!-- SECTION D√âCISION FINALE -->
          <div class="print-section decision-section">
            <h2>D√âCISION FINALE</h2>
            
            <div class="decision-finale-print">
              <div class="decision-option">
                <span [class.checked]="decisionFinale === 'Oui'">‚òê GO = OK pour incision</span>
              </div>
              <div class="decision-option">
                <span [class.checked]="decisionFinale === 'Non'">‚òê NO GO = Pas d'incision !</span>
              </div>
            </div>

            <div *ngIf="decisionFinale === 'Non'" class="consequences-print">
              <p><strong>Si No Go : cons√©quence sur l'intervention ?</strong></p>
              <div class="checkbox-print">
                <span [class.checked]="consequence === 'Retard'">‚òê Retard</span>
                <span [class.checked]="consequence === 'Annulation'">‚òê Annulation</span>
              </div>
            </div>
          </div>

          <!-- SIGNATURES -->
          <div class="signatures-section">
            <p class="signature-title"><strong>SELON PROC√âDURE EN VIGUEUR DANS L'√âTABLISSEMENT</strong></p>
            <p class="signature-subtitle">Attestation que la check-list a √©t√© renseign√©e suite √† un partage des informations entre les membres de l'√©quipe</p>
            
            <div class="signatures-grid">
              <div class="signature-box">
                <div class="signature-line"></div>
                <p>Chirurgien</p>
              </div>
              <div class="signature-box">
                <div class="signature-line"></div>
                <p>Anesth√©siste / IADE</p>
              </div>
              <div class="signature-box">
                <div class="signature-line"></div>
                <p>Coordonnateur CL</p>
              </div>
            </div>
          </div>

        </div>

        <div class="print-actions">
          <button class="btn-print-now" (click)="printChecklistNow()">
            üñ®Ô∏è Imprimer maintenant
          </button>
          <button class="btn-print-cancel" (click)="closePrintModal()">
            Annuler
          </button>
        </div>
      </div>
    </div>
  </div>
</div>