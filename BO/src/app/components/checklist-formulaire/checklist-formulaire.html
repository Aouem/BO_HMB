<div class="container my-4">
  <!-- En-t√™te -->
  <div class="progress-header mb-4">
    <h2 class="text-center text-primary mb-3 display-5 fw-bold">üìù {{ checklistNom }}</h2>

    <!-- Progression globale -->
    <div class="global-progress-container mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="progress-text fs-5 fw-semibold">Progression globale</span>
        <span class="progress-percentage fs-5 fw-bold text-primary">
          {{ getGlobalProgress() | number:'1.0-0' }}%
        </span>
      </div>
      <div class="progress medical-progress">
        <div class="progress-bar progress-bar-blue" [style.width]="getGlobalProgress() + '%'"></div>
      </div>
      <div class="text-center mt-2">
        <span class="badge bg-info fs-6">
          {{ etapesCompletees }}/{{ etapes.length }} √©tapes valid√©es
        </span>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="alert alert-info text-center fs-5">
    <div class="spinner-border me-3" role="status"></div>
    Chargement des questions...
  </div>

  <!-- Contenu principal (non-loading) -->
  <ng-container *ngIf="!loading">

    <!-- VUE √âTAPE (Tableau de bord) -->
    <div *ngIf="mode === 'etape'" class="etapes-container">
      <h3 class="text-center mb-4 display-6 fw-bold">√âtapes de la Checklist</h3>

      <div class="row g-4">
        <div *ngFor="let etape of etapes; let i = index" class="col-md-6 col-lg-4">
          <div class="etape-card" [ngClass]="getEtapeColorClass(i)">
            <div class="etape-header">
              <h4 class="etape-title">√âtape {{ i + 1 }}</h4>
              <div class="etape-status" [ngClass]="etapesValidees[i] ? 'status-complete' : 'status-incomplete'">
                {{ etapesValidees[i] ? '‚úÖ Valid√©e' : '‚è≥ En cours' }}
              </div>
            </div>

            <div class="etape-content">
              <h5 class="etape-nom">{{ etape.nom }}</h5>
              <div class="etape-progress-info">
                <div class="progress mb-2">
                  <div class="progress-bar"
                       [style.width]="getEtapeProgress(i) + '%'"
                       [ngClass]="etapesValidees[i] ? 'bg-success' : 'bg-warning'">
                  </div>
                </div>
                <small>{{ getEtapeAnsweredQuestions(i) }}/{{ etape.questions.length }} questions</small>
              </div>
            </div>

            <div class="etape-actions">
              <button *ngIf="!etapesValidees[i]"
                      class="btn btn-primary btn-sm"
                      (click)="commencerEtape(i)"
                      [disabled]="i > 0 && !etapesValidees[i-1]">
                {{ getEtapeAnsweredQuestions(i) > 0 ? 'Continuer' : 'Commencer' }}
              </button>

              <button *ngIf="etapesValidees[i]"
                      class="btn btn-outline-secondary btn-sm"
                      (click)="reouvrirEtape(i)">
                Modifier
              </button>

              <button *ngIf="etapesValidees[i]" class="btn btn-success btn-sm ms-2" disabled>
                ‚úÖ Valid√©
              </button>
            </div>

            <div *ngIf="i > 0 && !etapesValidees[i-1]" class="etape-blocage">
              <small class="text-warning">‚è≥ Completez l'√©tape {{ i }} d'abord</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Bouton de soumission finale -->
      <div *ngIf="toutesEtapesValidees()" class="text-center mt-5">
        <button class="btn btn-success btn-lg px-5" (click)="submitFinalForm()">
          üöÄ Soumettre le Formulaire Complet
        </button>
        <p class="text-muted mt-2">Toutes les √©tapes sont valid√©es !</p>
      </div>
    </div>

    <!-- VUE QUESTION (D√©tail d'une √©tape) ‚Äî MODE S√âQUENTIEL -->
    <div *ngIf="mode === 'question' && currentEtape as etape" class="questions-container">
      <!-- En-t√™te de l'√©tape -->
      <div class="etape-current-header mb-4">
        <button class="btn btn-outline-secondary mb-3" (click)="retourAuTableauDeBord()">
          ‚¨ÖÔ∏è Retour au tableau de bord
        </button>

        <div class="etape-banner" [ngClass]="getEtapeColorClass(currentEtapeIndex)">
          <h3 class="etape-title mb-2">√âtape {{ currentEtapeIndex + 1 }}/{{ etapes.length }}</h3>
          <p class="etape-description mb-0">{{ etape.nom }}</p>
        </div>

        <!-- Progression de l'√©tape -->
        <div class="etape-current-progress mt-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span>Progression de l'√©tape</span>
            <span class="fw-bold">{{ getEtapeProgress(currentEtapeIndex) | number:'1.0-0' }}%</span>
          </div>
          <div class="progress medical-progress">
            <div class="progress-bar"
                 [style.width]="getEtapeProgress(currentEtapeIndex) + '%'"
                 [ngClass]="getEtapeColorClass(currentEtapeIndex).replace('etape-color', 'progress-bar')">
            </div>
          </div>
        </div>
      </div>

      <!-- Question courante (une seule √† la fois) -->
      <div class="question-card mb-4"
           *ngIf="currentQuestion as question"
           [ngClass]="getAnswerCardClass(question.id)">
        <div class="question-header d-flex justify-content-between align-items-center">
          <h5 class="question-number mb-0">
            Question {{ currentQuestionIndex + 1 }} / {{ etape.questions.length }}
          </h5>

          <!-- Badge de r√©ponse choisie -->
          <ng-container *ngIf="getQuestionResponse(question.id) as rep">
            <span class="badge rounded-pill" [ngClass]="answerBadgeClass(rep)">
              {{ rep }}
            </span>
          </ng-container>
        </div>

        <p class="question-text fs-5 mt-3">{{ question.texte }}</p>

        <!-- R√©ponses -->
        <div *ngIf="question.type === 'Boolean' || question.type === 'BooleanNA'" class="boolean-options">
          <div class="btn-group" role="group" aria-label="R√©ponse Oui/Non">
            <button *ngFor="let val of getBooleanOptions(question.type)"
                    type="button"
                    class="btn"
                    [ngClass]="getChoiceBtnClasses(question.id, val)"
                    (click)="onAnswerSelected(question.id, val)">
              {{ val }}
            </button>
          </div>
        </div>

        <!-- Liste -->
        <div *ngIf="question.type === 'Liste'" class="mt-2">
          <select class="form-select"
                  [ngClass]="{'is-valid': getQuestionResponse(question.id)}"
                  [value]="getQuestionResponse(question.id) || ''"
                  (change)="onAnswerSelected(question.id, $any($event.target).value)">
            <option value="">S√©lectionnez...</option>
            <option *ngFor="let opt of question.options" [value]="opt.valeur">{{ opt.valeur }}</option>
          </select>
        </div>

        <!-- Texte -->
        <div *ngIf="question.type === 'Texte'" class="mt-2">
          <input type="text"
                 class="form-control"
                 [ngClass]="{'is-valid': getQuestionResponse(question.id)}"
                 [value]="getQuestionResponse(question.id) || ''"
                 (input)="onAnswerSelected(question.id, $any($event.target).value)"
                 placeholder="Votre r√©ponse...">
        </div>

        <!-- Navigation intra-√©tape -->
        <div class="d-flex justify-content-between align-items-center mt-4">
          <button class="btn btn-outline-secondary"
                  (click)="prevQuestion()"
                  [disabled]="isFirstQuestion">
            ‚¨ÖÔ∏è Pr√©c√©dente
          </button>

          <div class="text-muted small">
            Appuyez sur <strong>Suivante</strong> apr√®s avoir r√©pondu
          </div>

          <button *ngIf="!isLastQuestionInEtape"
                  class="btn btn-primary"
                  (click)="nextQuestion()"
                  [disabled]="!canGoNext()">
            Suivante ‚û°Ô∏è
          </button>

          <button *ngIf="isLastQuestionInEtape"
                  class="btn btn-success"
                  (click)="validerEtape()"
                  [disabled]="!isEtapeComplete(currentEtapeIndex)">
            ‚úÖ Valider l'√©tape
          </button>
        </div>

        <div *ngIf="!canGoNext()" class="text-warning mt-2">
          ‚ö†Ô∏è R√©pondez √† la question pour continuer
        </div>
      </div>

      <!-- Rappel de validation (optionnel) -->
      <div class="validation-etape text-center mt-5" *ngIf="!isLastQuestionInEtape">
        <button class="btn btn-outline-success btn-sm"
                (click)="validerEtape()"
                [disabled]="!isEtapeComplete(currentEtapeIndex)">
          Valider l'√©tape maintenant
        </button>
      </div>
    </div>

    <!-- Message de succ√®s -->
    <div *ngIf="submitted" class="alert alert-success text-center mt-4">
      <h4>üéâ Formulaire soumis avec succ√®s !</h4>
      <p class="mb-3">{{ answeredQuestions }} r√©ponses enregistr√©es</p>
      <button class="btn btn-outline-primary" (click)="resetForm()">
        üîÑ Nouveau Formulaire
      </button>
    </div>

    <!-- === VISUALISATION DES DONN√âES ENREGISTR√âES === -->
    <div class="row mt-3">
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h6 class="mb-0">üëÅÔ∏è Visualisation des Donn√©es Enregistr√©es</h6>
          </div>
          <div class="card-body">
            <!-- Alertes importantes (pas de tableau de d√©tail) -->
            <div *ngIf="getEtapesCompletesNonValidees().length > 0" class="alert alert-warning mt-2">
              <h6>‚ö†Ô∏è Attention:</h6>
              <p>Il y a {{ getEtapesCompletesNonValidees().length }} √©tape(s) compl√®te(s) mais non valid√©e(s):</p>
              <ul class="mb-0">
                <li *ngFor="let index of getEtapesCompletesNonValidees()">
                  √âtape {{ index + 1 }}: {{ etapes[index].nom }}
                  <button class="btn btn-success btn-sm ms-2" (click)="forcerValidationEtape(index)">
                    Valider maintenant
                  </button>
                </li>
              </ul>
            </div>
            <!-- Fin alertes -->
          </div>
        </div>
      </div>
    </div>

  </ng-container>
</div>
