<div class="checklists-container">
  <!-- En-tête avec onglets -->
  <div class="header-actions">
    <h1>🎯 Checklist Chirurgicale</h1>
    <div class="tabs-container">
      <button 
        class="tab-btn" 
        [class.active]="activeTab === 'edit'"
        (click)="activeTab = 'edit'">
        ✏️ Édition
      </button>
      <button 
        class="tab-btn" 
        [class.active]="activeTab === 'history'"
        (click)="loadAllSubmissions()">
        📊 Historique des Soumissions
      </button>
    </div>
    <button class="btn creative-btn gradient-btn" (click)="createNewChecklist()">
      ✨ Nouvelle Checklist
    </button>
  </div>

  <!-- ONGLET ÉDITION -->
  <div *ngIf="activeTab === 'edit'" class="tab-content">
    <!-- (Le contenu de l'onglet édition reste inchangé) -->
    <!-- Recherche -->
    <div class="search-container">
      <div class="search-box">
        <input 
          type="text" 
          class="form-control search-input" 
          placeholder="🔍 Rechercher une question ou une étape..."
          [(ngModel)]="searchTerm"
          (input)="filterChecklists()"
        />
        <button *ngIf="searchTerm" class="btn btn-clear" (click)="clearSearch()">
          ✕
        </button>
      </div>
    </div>

    <!-- Loading -->
    <div *ngIf="loading" class="loading-container">
      <div class="spinner"></div>
      <p>Chargement des checklists chirurgicales...</p>
    </div>

    <!-- Checklists -->
    <div *ngFor="let cl of filteredChecklists" class="checklist-block">
      
      <!-- Header Checklist -->
      <div class="checklist-header">
        <textarea 
          class="checklist-libelle"
          [(ngModel)]="cl.libelle"
          placeholder="Nom de la checklist chirurgicale"
          rows="2"
        ></textarea>
        
        <div class="checklist-stats">
          <span class="badge">{{ getTotalEtapes(cl) }} phases</span>
          <span class="badge">{{ getTotalQuestions(cl) }} vérifications</span>
        </div>

        <div class="action-buttons">
          <button class="btn creative-btn btn-info" (click)="viewChecklistDetail(cl.id!)">
            👁️ Voir
          </button>
          <button class="btn creative-btn btn-warning" (click)="editChecklist(cl.id!)">
            ✏️ Modifier
          </button>
          <button class="btn creative-btn btn-success" (click)="saveChecklist(cl)">
            💾 Sauvegarder
          </button>
          <button class="btn creative-btn btn-danger" (click)="deleteChecklist(cl)">
            🗑️ Supprimer
          </button>
        </div>
      </div>

      <!-- Étapes avec couleurs distinctives -->
      <div *ngFor="let etape of cl.etapes; let ei = index" 
           class="etape-block"
           [class.avant-intervention]="isAvantIntervention(etape.nom)"
           [class.pendant-intervention]="isPendantIntervention(etape.nom)"
           [class.apres-intervention]="isApresIntervention(etape.nom)"
           [class.controle-final]="isControleFinal(etape.nom)">
        
        <!-- Indicateur d'étape -->
        <div class="etape-indicator" 
             [class.avant]="isAvantIntervention(etape.nom)"
             [class.pendant]="isPendantIntervention(etape.nom)"
             [class.apres]="isApresIntervention(etape.nom)"
             [class.controle]="isControleFinal(etape.nom)">
          {{ ei + 1 }}
        </div>

        <!-- Badge type d'étape -->
        <div class="etape-badge"
             [class.avant]="isAvantIntervention(etape.nom)"
             [class.pendant]="isPendantIntervention(etape.nom)"
             [class.apres]="isApresIntervention(etape.nom)"
             [class.controle]="isControleFinal(etape.nom)">
          {{ getEtapeType(etape.nom) }}
        </div>

        <div class="etape-header">
          <textarea 
            class="etape-title"
            [class.avant-intervention]="isAvantIntervention(etape.nom)"
            [class.pendant-intervention]="isPendantIntervention(etape.nom)"
            [class.apres-intervention]="isApresIntervention(etape.nom)"
            [class.controle-final]="isControleFinal(etape.nom)"
            [(ngModel)]="etape.nom"
            placeholder="Nom de la phase chirurgicale"
            rows="2"
          ></textarea>
          <button class="btn creative-btn btn-danger" (click)="removeEtape(cl, ei)">
            🗑️
          </button>
        </div>

        <!-- Questions sans scroll -->
        <div *ngFor="let q of etape.questions; let qi = index" class="question-block">
          <div class="question-content-full">
            
            <!-- Question avec affichage complet sans scroll -->
            <textarea 
              class="question-text-field auto-expand"
              [class.long-question]="isLongQuestion(q.texte)"
              [class.confirmation-question]="isConfirmationQuestion(q.texte)"
              [class.important-question]="isImportantQuestion(q.texte)"
              [(ngModel)]="q.texte"
              placeholder="💡 Saisir la question de vérification..."
              (input)="onTextareaResize($event)"
              rows="3"
            ></textarea>

            <div class="selects-container">
              <select 
                class="creative-select"
                [ngModel]="q.type" 
                (ngModelChange)="updateQuestionType(q, $event)"
              >
                <option value="Boolean">✅ Oui/Non</option>
                <option value="BooleanNA">🔘 Oui/Non/N-A</option>
                <option value="Texte">📝 Texte libre</option>
                <option value="Liste">📋 Liste déroulante</option>
              </select>

              <select 
                *ngIf="q.type === 'Boolean' || q.type === 'BooleanNA'" 
                class="creative-select"
                [(ngModel)]="q.reponse"
              >
                <option value="">🎯 Sélectionner</option>
                <option *ngFor="let option of getBooleanOptions(q)" [value]="option">
                  {{ option }}
                </option>
              </select>
            </div>

            <!-- Champ texte pour réponses longues -->
            <textarea 
              *ngIf="q.type === 'Texte'"
              class="creative-select auto-expand"
              [(ngModel)]="q.reponse"
              placeholder="✍️ Saisir la réponse ou les observations..."
              (input)="onTextareaResize($event)"
              rows="4"
            ></textarea>

            <!-- Options pour listes déroulantes -->
            <div *ngIf="q.type === 'Liste'" class="options-container">
              <div *ngFor="let o of q.options; let oi = index" class="option-row">
                <textarea 
                  class="option-field auto-expand"
                  [(ngModel)]="o.valeur"
                  placeholder="📌 Option de réponse..."
                  (input)="onTextareaResize($event)"
                  rows="2"
                ></textarea>
                <button class="btn creative-btn btn-danger" (click)="removeOption(q, oi)">
                  🗑️
                </button>
              </div>
              <button class="btn creative-btn btn-secondary" (click)="addOption(q)">
                ➕ Ajouter une option
              </button>
            </div>

            <button class="btn creative-btn btn-warning" (click)="removeQuestion(etape, qi)">
              🗑️ Supprimer cette vérification
            </button>
          </div>
        </div>

        <button class="btn creative-btn gradient-btn" (click)="addQuestion(etape)">
          ❓ Ajouter une vérification
        </button>
      </div>

      <button class="btn creative-btn gradient-btn" (click)="addEtape(cl)">
        📋 Ajouter une phase chirurgicale
      </button>
    </div>

    <!-- État vide -->
    <div *ngIf="!loading && filteredChecklists.length === 0" class="empty-state">
      <h2>{{ searchTerm ? 'Aucune vérification trouvée' : 'Aucune checklist chirurgicale' }}</h2>
      <p>Créez votre première checklist pour les procédures chirurgicales</p>
      <button class="btn creative-btn gradient-btn" (click)="createNewChecklist()">
        ✨ Créer une checklist chirurgicale
      </button>
    </div>
  </div>

  <!-- ONGLET HISTORIQUE -->
  <div *ngIf="activeTab === 'history'" class="tab-content">
    <div class="history-header">
      <h2>📊 Historique des Soumissions</h2>
      <div class="history-actions">
        <button class="btn creative-btn btn-secondary" (click)="activeTab = 'edit'">
          ← Retour à l'édition
        </button>
        <button *ngIf="submissions.length > 0" class="btn creative-btn btn-primary" (click)="printAllSubmissions()">
          🖨️ Imprimer tout l'historique
        </button>
      </div>
    </div>

    <!-- Loading historique -->
    <div *ngIf="submissionsLoading" class="loading-container">
      <div class="spinner"></div>
      <p>Chargement de l'historique des soumissions...</p>
    </div>

    <!-- Tableau des soumissions -->
    <div *ngIf="!submissionsLoading" class="submissions-container">
      <div *ngIf="submissions.length === 0" class="empty-state">
        <h3>Aucune soumission trouvée</h3>
        <p>Les soumissions apparaîtront ici une fois que les formulaires seront complétés</p>
      </div>

      <div *ngIf="submissions.length > 0" class="table-container">
        <table class="submissions-table">
          <thead>
            <tr>
              <th>ID Checklist</th>
              <th>Nom Checklist</th>
              <th>Date</th>
              <th>Utilisateur</th>
              <th>Statut</th>
              <th>Actions</th>
              <th>Impression</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let submission of submissions" class="submission-row">
              <td class="checklist-id">{{ submission.checkListId }}</td>
              <td class="checklist-name">{{ submission.checklistName }}</td>
              <td class="submission-date">{{ formatDate(submission.submittedAt) }}</td>
              <td class="submission-user">{{ submission.submittedBy }}</td>
              <td class="submission-status">
                <span class="badge" [ngClass]="getSubmissionStatus(submission).class">
                  {{ getSubmissionStatus(submission).text }}
                </span>
              </td>
              <td class="submission-actions">
                <button 
                  class="btn creative-btn btn-info" 
                  (click)="showSubmissionDetails(submission)">
                  📋 Détails
                </button>
              </td>
              <td class="print-actions">
                <!-- BOUTON CORRIGÉ : utilisation de (click) au lieu de onclick -->
                <button class="btn creative-btn btn-print" (click)="printSubmission(submission)">
                  🖨️ Imprimer
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Modal de détails -->
      <div *ngIf="selectedSubmission" class="modal-overlay" (click)="hideSubmissionDetails()">
        <div class="modal-content" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h3>📋 Détails de la Soumission #{{ selectedSubmission.id }}</h3>
            <button class="btn-close" (click)="hideSubmissionDetails()">×</button>
          </div>
          
          <div class="modal-body">
            <div class="submission-info">
              <p><strong>Checklist:</strong> {{ selectedSubmission.checklistName }}</p>
              <p><strong>Date:</strong> {{ formatDate(selectedSubmission.submittedAt) }}</p>
              <p><strong>Utilisateur:</strong> {{ selectedSubmission.submittedBy }}</p>
              <p><strong>Nombre de réponses:</strong> {{ selectedSubmission.reponses.length }}</p>
            </div>

            <div class="responses-summary">
              <h4>📈 Résumé des réponses</h4>
              <div class="stats-grid">
                <div class="stat-item">
                  <span class="stat-value">{{ countResponsesByType(selectedSubmission).oui }}</span>
                  <span class="stat-label">✅ Oui</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value">{{ countResponsesByType(selectedSubmission).non }}</span>
                  <span class="stat-label">❌ Non</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value">{{ countResponsesByType(selectedSubmission).na }}</span>
                  <span class="stat-label">⚪ N/A</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value">{{ countResponsesByType(selectedSubmission).texte }}</span>
                  <span class="stat-label">📝 Texte</span>
                </div>
              </div>
            </div>

            <!-- Détails des questions/réponses -->
            <div class="questions-details">
              <h4>📋 Détail des vérifications</h4>
              <div *ngFor="let response of selectedSubmission.reponses; let i = index" class="response-item">
                <div class="response-question">
                  <strong>Q{{ i + 1 }}:</strong> 
                  {{ getQuestionText(response.questionId) }}
                </div>
                <div class="response-answer" [ngClass]="getAnswerClass(response.reponse)">
                  <strong>Réponse:</strong> {{ response.reponse || 'Non répondu' }}
                </div>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn creative-btn btn-secondary" (click)="hideSubmissionDetails()">
              Fermer
            </button>
            <!-- Bouton d'impression dans le modal -->
            <button class="btn creative-btn btn-primary" (click)="printSubmission(selectedSubmission)">
              🖨️ Imprimer cette soumission
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>