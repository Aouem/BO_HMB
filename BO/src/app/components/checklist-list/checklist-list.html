<div class="checklists-container">
  <!-- En-tÃªte avec onglets -->
  <div class="header-actions">
    <h1>ğŸ¯ Checklist Chirurgicale</h1>
    <div class="tabs-container">
      <button 
        class="tab-btn" 
        [class.active]="activeTab === 'edit'"
        (click)="activeTab = 'edit'">
        âœï¸ Ã‰dition
      </button>
      <button 
        class="tab-btn" 
        [class.active]="activeTab === 'history'"
        (click)="loadAllSubmissions()">
        ğŸ“Š Historique des Soumissions
      </button>
    </div>
    <button class="btn creative-btn gradient-btn" (click)="createNewChecklist()">
      âœ¨ Nouvelle Checklist
    </button>
  </div>

  <!-- ONGLET Ã‰DITION -->
  <div *ngIf="activeTab === 'edit'" class="tab-content">
    <!-- (Le contenu de l'onglet Ã©dition reste inchangÃ©) -->
    <!-- Recherche -->
    <div class="search-container">
      <div class="search-box">
        <input 
          type="text" 
          class="form-control search-input" 
          placeholder="ğŸ” Rechercher une question ou une Ã©tape..."
          [(ngModel)]="searchTerm"
          (input)="filterChecklists()"
        />
        <button *ngIf="searchTerm" class="btn btn-clear" (click)="clearSearch()">
          âœ•
        </button>
      </div>
    </div>

    <!-- Loading -->
    <div *ngIf="loading" class="loading-container">
      <div class="spinner"></div>
      <p>Chargement des checklists chirurgicales...</p>
    </div>

    <!-- Checklists -->
    <div *ngFor="let cl of filteredChecklists" class="checklist-block">
      
      <!-- Header Checklist -->
      <div class="checklist-header">
        <textarea 
          class="checklist-libelle"
          [(ngModel)]="cl.libelle"
          placeholder="Nom de la checklist chirurgicale"
          rows="2"
        ></textarea>
        
        <div class="checklist-stats">
          <span class="badge">{{ getTotalEtapes(cl) }} phases</span>
          <span class="badge">{{ getTotalQuestions(cl) }} vÃ©rifications</span>
        </div>

        <div class="action-buttons">
          <button class="btn creative-btn btn-info" (click)="viewChecklistDetail(cl.id!)">
            ğŸ‘ï¸ Voir
          </button>
          <button class="btn creative-btn btn-warning" (click)="editChecklist(cl.id!)">
            âœï¸ Modifier
          </button>
          <button class="btn creative-btn btn-success" (click)="saveChecklist(cl)">
            ğŸ’¾ Sauvegarder
          </button>
          <button class="btn creative-btn btn-danger" (click)="deleteChecklist(cl)">
            ğŸ—‘ï¸ Supprimer
          </button>
        </div>
      </div>

      <!-- Ã‰tapes avec couleurs distinctives -->
      <div *ngFor="let etape of cl.etapes; let ei = index" 
           class="etape-block"
           [class.avant-intervention]="isAvantIntervention(etape.nom)"
           [class.pendant-intervention]="isPendantIntervention(etape.nom)"
           [class.apres-intervention]="isApresIntervention(etape.nom)"
           [class.controle-final]="isControleFinal(etape.nom)">
        
        <!-- Indicateur d'Ã©tape -->
        <div class="etape-indicator" 
             [class.avant]="isAvantIntervention(etape.nom)"
             [class.pendant]="isPendantIntervention(etape.nom)"
             [class.apres]="isApresIntervention(etape.nom)"
             [class.controle]="isControleFinal(etape.nom)">
          {{ ei + 1 }}
        </div>

        <!-- Badge type d'Ã©tape -->
        <div class="etape-badge"
             [class.avant]="isAvantIntervention(etape.nom)"
             [class.pendant]="isPendantIntervention(etape.nom)"
             [class.apres]="isApresIntervention(etape.nom)"
             [class.controle]="isControleFinal(etape.nom)">
          {{ getEtapeType(etape.nom) }}
        </div>

        <div class="etape-header">
          <textarea 
            class="etape-title"
            [class.avant-intervention]="isAvantIntervention(etape.nom)"
            [class.pendant-intervention]="isPendantIntervention(etape.nom)"
            [class.apres-intervention]="isApresIntervention(etape.nom)"
            [class.controle-final]="isControleFinal(etape.nom)"
            [(ngModel)]="etape.nom"
            placeholder="Nom de la phase chirurgicale"
            rows="2"
          ></textarea>
          <button class="btn creative-btn btn-danger" (click)="removeEtape(cl, ei)">
            ğŸ—‘ï¸
          </button>
        </div>

        <!-- Questions sans scroll -->
        <div *ngFor="let q of etape.questions; let qi = index" class="question-block">
          <div class="question-content-full">
            
            <!-- Question avec affichage complet sans scroll -->
            <textarea 
              class="question-text-field auto-expand"
              [class.long-question]="isLongQuestion(q.texte)"
              [class.confirmation-question]="isConfirmationQuestion(q.texte)"
              [class.important-question]="isImportantQuestion(q.texte)"
              [(ngModel)]="q.texte"
              placeholder="ğŸ’¡ Saisir la question de vÃ©rification..."
              (input)="onTextareaResize($event)"
              rows="3"
            ></textarea>

            <div class="selects-container">
              <select 
                class="creative-select"
                [ngModel]="q.type" 
                (ngModelChange)="updateQuestionType(q, $event)"
              >
                <option value="Boolean">âœ… Oui/Non</option>
                <option value="BooleanNA">ğŸ”˜ Oui/Non/N-A</option>
                <option value="Texte">ğŸ“ Texte libre</option>
                <option value="Liste">ğŸ“‹ Liste dÃ©roulante</option>
              </select>

              <select 
                *ngIf="q.type === 'Boolean' || q.type === 'BooleanNA'" 
                class="creative-select"
                [(ngModel)]="q.reponse"
              >
                <option value="">ğŸ¯ SÃ©lectionner</option>
                <option *ngFor="let option of getBooleanOptions(q)" [value]="option">
                  {{ option }}
                </option>
              </select>
            </div>

            <!-- Champ texte pour rÃ©ponses longues -->
            <textarea 
              *ngIf="q.type === 'Texte'"
              class="creative-select auto-expand"
              [(ngModel)]="q.reponse"
              placeholder="âœï¸ Saisir la rÃ©ponse ou les observations..."
              (input)="onTextareaResize($event)"
              rows="4"
            ></textarea>

            <!-- Options pour listes dÃ©roulantes -->
            <div *ngIf="q.type === 'Liste'" class="options-container">
              <div *ngFor="let o of q.options; let oi = index" class="option-row">
                <textarea 
                  class="option-field auto-expand"
                  [(ngModel)]="o.valeur"
                  placeholder="ğŸ“Œ Option de rÃ©ponse..."
                  (input)="onTextareaResize($event)"
                  rows="2"
                ></textarea>
                <button class="btn creative-btn btn-danger" (click)="removeOption(q, oi)">
                  ğŸ—‘ï¸
                </button>
              </div>
              <button class="btn creative-btn btn-secondary" (click)="addOption(q)">
                â• Ajouter une option
              </button>
            </div>

            <button class="btn creative-btn btn-warning" (click)="removeQuestion(etape, qi)">
              ğŸ—‘ï¸ Supprimer cette vÃ©rification
            </button>
          </div>
        </div>

        <button class="btn creative-btn gradient-btn" (click)="addQuestion(etape)">
          â“ Ajouter une vÃ©rification
        </button>
      </div>

      <button class="btn creative-btn gradient-btn" (click)="addEtape(cl)">
        ğŸ“‹ Ajouter une phase chirurgicale
      </button>
    </div>

    <!-- Ã‰tat vide -->
    <div *ngIf="!loading && filteredChecklists.length === 0" class="empty-state">
      <h2>{{ searchTerm ? 'Aucune vÃ©rification trouvÃ©e' : 'Aucune checklist chirurgicale' }}</h2>
      <p>CrÃ©ez votre premiÃ¨re checklist pour les procÃ©dures chirurgicales</p>
      <button class="btn creative-btn gradient-btn" (click)="createNewChecklist()">
        âœ¨ CrÃ©er une checklist chirurgicale
      </button>
    </div>
  </div>

  <!-- ONGLET HISTORIQUE -->
  <div *ngIf="activeTab === 'history'" class="tab-content">
    <div class="history-header">
      <h2>ğŸ“Š Historique des Soumissions</h2>
      <div class="history-actions">
        <button class="btn creative-btn btn-secondary" (click)="activeTab = 'edit'">
          â† Retour Ã  l'Ã©dition
        </button>
        <button *ngIf="submissions.length > 0" class="btn creative-btn btn-primary" (click)="printAllSubmissions()">
          ğŸ–¨ï¸ Imprimer tout l'historique
        </button>
      </div>
    </div>

    <!-- Loading historique -->
    <div *ngIf="submissionsLoading" class="loading-container">
      <div class="spinner"></div>
      <p>Chargement de l'historique des soumissions...</p>
    </div>

    <!-- Tableau des soumissions -->
    <div *ngIf="!submissionsLoading" class="submissions-container">
      <div *ngIf="submissions.length === 0" class="empty-state">
        <h3>Aucune soumission trouvÃ©e</h3>
        <p>Les soumissions apparaÃ®tront ici une fois que les formulaires seront complÃ©tÃ©s</p>
      </div>

      <div *ngIf="submissions.length > 0" class="table-container">
        <table class="submissions-table">
          <thead>
            <tr>
              <th>ID Checklist</th>
              <th>Nom Checklist</th>
              <th>Date</th>
              <th>Utilisateur</th>
              <th>Statut</th>
              <th>Actions</th>
              <th>Impression</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let submission of submissions" class="submission-row">
              <td class="checklist-id">{{ submission.checkListId }}</td>
              <td class="checklist-name">{{ submission.checklistName }}</td>
              <td class="submission-date">{{ formatDate(submission.submittedAt) }}</td>
              <td class="submission-user">{{ submission.submittedBy }}</td>
              <td class="submission-status">
                <span class="badge" [ngClass]="getSubmissionStatus(submission).class">
                  {{ getSubmissionStatus(submission).text }}
                </span>
              </td>
              <td class="submission-actions">
                <button 
                  class="btn creative-btn btn-info" 
                  (click)="showSubmissionDetails(submission)">
                  ğŸ“‹ DÃ©tails
                </button>
              </td>
              <td class="print-actions">
                <!-- BOUTON CORRIGÃ‰ : utilisation de (click) au lieu de onclick -->
                <button class="btn creative-btn btn-print" (click)="printSubmission(submission)">
                  ğŸ–¨ï¸ Imprimer
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Modal de dÃ©tails -->
      <div *ngIf="selectedSubmission" class="modal-overlay" (click)="hideSubmissionDetails()">
        <div class="modal-content" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h3>ğŸ“‹ DÃ©tails de la Soumission #{{ selectedSubmission.id }}</h3>
            <button class="btn-close" (click)="hideSubmissionDetails()">Ã—</button>
          </div>
          
          <div class="modal-body">
            <div class="submission-info">
              <p><strong>Checklist:</strong> {{ selectedSubmission.checklistName }}</p>
              <p><strong>Date:</strong> {{ formatDate(selectedSubmission.submittedAt) }}</p>
              <p><strong>Utilisateur:</strong> {{ selectedSubmission.submittedBy }}</p>
              <p><strong>Nombre de rÃ©ponses:</strong> {{ selectedSubmission.reponses.length }}</p>
            </div>

            <div class="responses-summary">
              <h4>ğŸ“ˆ RÃ©sumÃ© des rÃ©ponses</h4>
              <div class="stats-grid">
                <div class="stat-item">
                  <span class="stat-value">{{ countResponsesByType(selectedSubmission).oui }}</span>
                  <span class="stat-label">âœ… Oui</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value">{{ countResponsesByType(selectedSubmission).non }}</span>
                  <span class="stat-label">âŒ Non</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value">{{ countResponsesByType(selectedSubmission).na }}</span>
                  <span class="stat-label">âšª N/A</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value">{{ countResponsesByType(selectedSubmission).texte }}</span>
                  <span class="stat-label">ğŸ“ Texte</span>
                </div>
              </div>
            </div>

            <!-- DÃ©tails des questions/rÃ©ponses -->
            <div class="questions-details">
              <h4>ğŸ“‹ DÃ©tail des vÃ©rifications</h4>
              <div *ngFor="let response of selectedSubmission.reponses; let i = index" class="response-item">
                <div class="response-question">
                  <strong>Q{{ i + 1 }}:</strong> 
                  {{ getQuestionText(response.questionId) }}
                </div>
                <div class="response-answer" [ngClass]="getAnswerClass(response.reponse)">
                  <strong>RÃ©ponse:</strong> {{ response.reponse || 'Non rÃ©pondu' }}
                </div>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn creative-btn btn-secondary" (click)="hideSubmissionDetails()">
              Fermer
            </button>
            <!-- Bouton d'impression dans le modal -->
            <button class="btn creative-btn btn-primary" (click)="printSubmission(selectedSubmission)">
              ğŸ–¨ï¸ Imprimer cette soumission
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>